filter {
    if [type] == "syslog" {
        if ([message] =~ /meraki/) or ([message] =~ /\b urls \b/) {
        mutate {
            add_field => {
                    "dataType" => "firewall-meraki"
            }
            rename => {
                "host" => "dataSource"
            }
        }
        mutate {
            gsub => ["message", "[\r]", ""]
        }
        grok {
            match => {
                "message" => "%{CISCOTIMESTAMP:timestamp} %{IP:ip} %{INT:bytes} %{BASE10NUM:epoch_time} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{CISCOTIMESTAMP:timestamp} %{IP:ip} %{INT:bytes} %{BASE10NUM:epoch_time} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} agent='%{GREEDYDATA:agent}' request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{BASE10NUM:epoch_time} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{BASE10NUM:epoch_time} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} agent='%{GREEDYDATA:agent}' request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{GREEDYDATA:unknown_info} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{GREEDYDATA:unknown_info} %{WORD:device_name} %{WORD:kind} src=%{IPV4:src_ip}:%{WORD:src_port} dst=%{IPV4:dest_ip}:%{WORD:dest_port} mac=%{MAC:mac} agent='%{GREEDYDATA:agent}' request: %{GREEDYDATA:request} %{GREEDYDATA:url}"
            }
            match => {
                "message" => "%{GREEDYDATA:unknown_info} %{WORD:device_name} urls %{GREEDYDATA:unknown_info}"
            }
        }
        if [epoch_time] {
            date {
                match => ["epoch_time", "UNIX"]
            }
        }
        else if [timestamp] {
            date {
                match => ["timestamp", "UNIX"]
            }
        }
        if [src_ip] and [request] and [url] {
            mutate {
                add_field => {
                    "[logx][meraki][summary]" => "A client with IP address %{src_ip} sent a HTTP %{request} request for %{url}."
                }
            }
        }
        if [ip] {
            mutate {
                rename => {
                    "ip" => "[logx][meraki][ip]"
                }
            }
        }
        if [bytes] {
            mutate {
                rename => {
                    "bytes" => "[logx][meraki][bytes]"
                }
                convert => {
                    "[logx][meraki][bytes]" => "integer"
                }
            }
        }
        if [device_name] {
            mutate {
                rename => {
                    "device_name" => "[logx][meraki][deviceName]"
                }
            }
        }
        if [kind] {
            mutate {
                rename => {
                    "kind" => "[logx][meraki][kind]"
                }
            }
        }
        if [src_ip] {
            mutate {
                rename => {
                    "src_ip" => "[logx][meraki][src_ip]"
                }
            }
        }
        if [src_port] {
            mutate {
                rename => {
                    "src_port" => "[logx][meraki][src_port]"
                }
                convert => {
                    "[logx][meraki][src_port]" => "integer"
                }
            }
        }
        if [dest_ip] {
            mutate {
                rename => {
                    "dest_ip" => "[logx][meraki][dest_ip]"
                }
            }
        }
        if [dest_port] {
            mutate {
                rename => {
                    "dest_port" => "[logx][meraki][dest_port]"
                }
                convert => {
                    "[logx][meraki][dest_port]" => "integer"
                }
            }
        }
        if [mac] {
            mutate {
                rename => {
                    "mac" => "[logx][meraki][details][mac]"
                }
            }
        }
        if [agent] {
            mutate {
                rename => {
                    "agent" => "[logx][meraki][details][agent]"
                }
            }
        }
        if [request] {
            mutate {
                rename => {
                    "request" => "[logx][meraki][details][httpMethod]"
                }
            }
        }
        if [url] {
            mutate {
                rename => {
                    "url" => "[logx][meraki][details][url]"
                }
            }
        }
        if [unknown_info] {
            mutate {
                add_field => {
                    "[logx][meraki][parsingProblem]" => "Unfamiliar meraki log type."
                }
                add_field => {
                    "[logx][meraki][unknownInfo]" => ["unknown_info"]
                }
            }
        }
        mutate {
            remove_field => ["path", "@version", "message", "tags", "epoch_time", "timestamp"]
        }
    }
    }
}